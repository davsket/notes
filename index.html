<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" manifest="manifest.cache">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<title i18n-content="appname">Note Editor</title>
		<link rel="shortcut icon" href="http://davsket.me/notes/sicon.png">
		<style type="text/css">
		@font-face {
		    font-family: 'symbol';
		    src: url('font/websymbols-regular-webfont.eot');
		    src: url('font/websymbols-regular-webfont.eot?#iefix') format('embedded-opentype'),
		         url('font/websymbols-regular-webfont.woff') format('woff'),
		         url('font/websymbols-regular-webfont.ttf') format('truetype'),
		         url('font/websymbols-regular-webfont.svg#WebSymbolsRegular') format('svg');
		    font-weight: normal;
		    font-style: normal;
		}

		/* Erics reset */
		/* http://meyerweb.com/eric/tools/css/reset/ 
		   v2.0 | 20110126
		   License: none (public domain)
		*/

		html, body, div, span, applet, object, iframe,
		h1, h2, h3, h4, h5, h6, p, blockquote, pre,
		a, abbr, acronym, address, big, cite, code,
		del, dfn, em, img, ins, kbd, q, s, samp,
		small, strike, strong, sub, sup, tt, var,
		b, u, i, center,
		dl, dt, dd, ol, ul, li,
		fieldset, form, label, legend,
		table, caption, tbody, tfoot, thead, tr, th, td,
		article, aside, canvas, details, embed, 
		figure, figcaption, footer, header, hgroup, 
		menu, nav, output, ruby, section, summary,
		time, mark, audio, video {
			margin: 0;
			padding: 0;
			border: 0;
			font-size: 100%;
			font: inherit;
			vertical-align: baseline;
		}
		/* HTML5 display-role reset for older browsers */
		article, aside, details, figcaption, figure, 
		footer, header, hgroup, menu, nav, section {
			display: block;
		}
		body {
			line-height: 1;
		}
		ol, ul {
			list-style: none;
		}
		blockquote, q {
			quotes: none;
		}
		blockquote:before, blockquote:after,
		q:before, q:after {
			content: '';
			content: none;
		}
		table {
			border-collapse: collapse;
			border-spacing: 0;
		}
		/* End Reset */
		[draggable] {
			-webkit-user-select: none;
			user-select: none;
		}
		html {
			background:#000000;
			padding: 0;
			margin: 0;
			height:100%;
			width:100%;
			background-color: white;
			background-image: -webkit-linear-gradient(0deg, transparent 30px, #ABCED4 30px, #ABCED4 31px, transparent 31px), -webkit-linear-gradient(#EEE 0.05em, transparent 0.05em);
			background-size: 100% 1.2em;
			font-family: sans-serif;
		}

		body {
			height:100%;
			padding: 0 20px 0 45px;
			margin: 0;
		}

		section {
			cursor:text;
			display:block;
			height:100%;
			padding-bottom:0px;
			padding-top:0px;
			width:100%;
		}

		#textarea{
			box-sizing:border-box;
			-webkit-box-sizing:border-box;
			color:#888;
			display:block;
			font-family: sans-serif;
			font-size:12pt;
			line-height:19px;
			margin: 0 auto;
			max-width: 600px;
			outline:none;
			padding: 0;
			padding: 20px 0px 40px 0px;
			position: relative;
			width: 100%;
			z-index: 1;
			min-height: 100%;
			height: auto;
		}
		#textarea img{
			display: block;
		}
		#menu{
			position: absolute;
			left: 6px;
			top: 6px;
			color: #AAA;
			text-decoration: none;
			padding-right: 10px;
		}
		#menu .index{
			position: relative;
			width: auto;
			z-index: 1;
			font-family: symbol;
			font-size: 18px;
		}
		#menu:hover{
			color: #777;
			cursor: default;
			z-index: 3;
		}
		#menu:hover .index{
			color: #ABCED4;
		}
		#menu:hover .items{
			/*height: 300px;*/
			left: 0;
		}
		#menu .items{
			/*height: 0;*/
			overflow: hidden;
			list-style: none;
			font-size: 12px;
			top: 0;
			margin: 0;
			padding: 0;
			-webkit-transition-property: all;
			-webkit-transition-duration: 500ms;
			background-color: #fff;
			position: relative;
			left: -1000px;
			border: 1px solid #ddd;
		}
		#menu li{
			list-style: none;
			padding: 5px 50px 5px 5px;
			margin: 0;
			font-family: sans-serif;
			cursor: pointer;
			position: relative;
		}
		#menu li.dragging{
			cursor: move;
			opacity: 0.5;
		}
		#menu li.over{
			border-top: 2em solid #ddd;
		}
		#menu .option{
			color: #ddd;
		}
		#menu li:hover .option{
			color: #fff;
		}
		#menu .delete{
			position: absolute;
			right: 5px;
			padding: 5px;
			top: 0;
		}
		#menu .rename{
			position: absolute;
			right: 20px;
			padding: 5px;
			top: 0;
			font-family: symbol;
			font-size: 11px;
		}
		#menu li:hover .delete:hover{
			color: #ee8888;
		}
		#menu li:hover .rename:hover{
			color: #6688aa;
		}
		#menu li:hover{
			color: #fff;
			background: #ABCED4;
		}
		#menu ul{
			padding: 0;
			margin: 0;
		}
		#status{
			position: fixed;
			right: 0;
			bottom: 0;
			padding: 10px;
			color: #333;
			background-color: #DDD;
			opacity: 0;
			-webkit-transition-property: opacity;
			-webkit-transition-duration: 500ms;
		}
		#status.show{
			opacity: 1;
		}
		#status.hide{
			-webkit-transition-delay: 5s;
			opacity: 0;
		}
		#newnote{
			border-top: 1px solid #ddd;
		}
		</style>
		
	</head>
	<body>
		<div id="menu">
			<span href="#" class="index">Â²</span>
			<div class="items">
				<ul id="menulist">
					<li id="newnote">
						New Note
					</li>
				</ul>
			</div>
		</div>
		<div id="textarea" spellcheck="true" contenteditable ></div>
		<div id="status" class='hide'></div>
		<script type="text/javascript">
			var actualnote = '',
				listsPrefix = 'notes/lists',
				notesPrefix = 'notes/lists/',
				lastPrefix = 'notes/lastlist',
				clearTextarea = false;

			Storage.prototype.getItemJSON = function(item){
				var val = this.getItem(item)||'null';
				try{
					return JSON.parse(val);
				}catch(e){
					return val;
				}
			}
			Element.prototype.hasClassName = function(name) {
			  return new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)").test(this.className);
			};

			Element.prototype.addClassName = function(name) {
			  if (!this.hasClassName(name)) {
			    this.className = this.className ? [this.className, name].join(' ') : name;
			  }
			};

			Element.prototype.removeClassName = function(name) {
			  if (this.hasClassName(name)) {
			    var c = this.className;
			    this.className = c.replace(new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)", "g"), "");
			  }
			};
			
			initialize();

			function saveContent(){
				localStorage.setItem(notesPrefix+localStorage.getItem(lastPrefix), textarea.innerHTML);
				if(clearTextarea){
					clearTextarea = false;
					textarea.innerHTML = cleanStylesAndSpaces(textarea.innerHTML);
				}
			}

			textarea.addEventListener('keyup', saveContent);
			textarea.addEventListener('paste', function(evt){
				clearTextarea = true;
				saveContent();
				clearTextarea = true;
			});

			function cancel(evt){
				evt.preventDefault();
			    evt.dataTransfer.dropEffect = 'copy';
				return false;
			}
			textarea.addEventListener('dragenter', cancel);
			textarea.addEventListener('dragover', cancel);

			textarea.addEventListener('drop', function(evt){
				evt.preventDefault();
				//console.log(evt.dataTransfer);

				
				if (evt.dataTransfer.types){
					//console.log(evt.dataTransfer.types);
				    [].forEach.call(evt.dataTransfer.types, function (type) {
				    	if(type == 'text/html'){
				    		evt.target.innerHTML += cleanStylesAndSpaces(evt.dataTransfer.getData(type));
				    	}
				    	else if(type == 'Files'){
				    		var file = evt.dataTransfer.files[0],
								reader = new FileReader();
							if(file.type.match(/image/)){
								reader.onload = function (event) {
									evt.target.innerHTML += '<img src="'+event.target.result+'" />';
								};
							}
							reader.readAsDataURL(file);
							soma = file;
				    	}
				    });
				    
				} else {
					evt.target.innerHTML = evt.dataTransfer.getData('Text');
				}

				return false;
			});

			newnote.addEventListener('click', function(evt){
				var name = window.prompt('New note name:');
				evt.cancelBubble = true;
				evt.preventDefault();
				if(name){
					createNote(name);
					loadNote(name);
				}
			});

			menulist.addEventListener('click', function(evt){
				var tn = evt.target.tagName, name, bool;
				if(tn == 'LI'){
					loadNote(evt.target.getElementsByClassName('txt')[0].innerHTML);
				}
				else if(tn == 'SPAN' && !/option/.test(evt.target.className)){
					loadNote(evt.target.parentElement.getElementsByClassName('txt')[0].innerHTML);
				}
				else if(tn == 'SPAN' && /delete/.test(evt.target.className)){
					name = evt.target.parentElement.getElementsByClassName('txt')[0].innerHTML;
					bool = window.confirm('Are you sure you want to delete the note: '+name+'?');
					if(!bool) return false;
					//if(name == 'Main'){
					//	alert('You can\'t delete this note.');
					//	return false;
					//}
					else{
						menulist.removeChild(evt.target.parentElement);
						deleteNote(name);
					}
				}
				else if(tn == 'SPAN' && /rename/.test(evt.target.className)){
					var text = evt.target.parentElement.getElementsByClassName('txt')[0],
						oldname = text.innerHTML,
						name = window.prompt('New note name:');
					if(!name){
						return false;
					} 
					else{
						text.innerHTML = name;
						localStorage.setItem(notesPrefix+name, localStorage.getItem(notesPrefix+oldname));
						newlists = localStorage.getItemJSON(listsPrefix);
						newlists.push(name);
						localStorage.setItem(listsPrefix, JSON.stringify(newlists));
						deleteNote(oldname);
						loadNote(name);
					}
				}
			});

			function initialize(){
				var lists, i, list, length;
				lists = localStorage.getItemJSON(listsPrefix);
				if(!lists || lists.length == 0){
					loadNote();
				}
				else{
					for (i = 0; i < lists.length; i++) {
						list = lists[i];
						createMenuItem(list);
					}
					loadNote(localStorage.getItemJSON(lastPrefix));
				}
			}

			function loadNote(noteName){
				if(!noteName){
					noteName = 'New note';
					createNote(noteName);
				}
				localStorage.setItem(lastPrefix, noteName);
				textarea.innerHTML = localStorage.getItemJSON(notesPrefix+noteName) || 'Write something...';

				//length = textarea.innerHTML.length;
				//textarea.scrollTop = textarea.scrollHeight;
				//textarea.setSelectionRange(length, length);
				textarea.focus();
				document.title = 'Editing ' + noteName;
			}

			function createNote(name, ignore_new_item){
				lists = localStorage.getItemJSON(listsPrefix);
				if(!lists){
					lists = [];
				}
				for(var i=0; i<lists.length; i++){
					if(lists[i] == name){
						alert('Already extists anote with the name: '+name+'. Opening note '+name+'.');
						loadNote(name);
						return false;
					}
				}
				if(!ignore_new_item){
					createMenuItem(name);
				}
				lists.push(name)
				localStorage.setItem(listsPrefix,JSON.stringify(lists));
			}

			function createMenuItem(note){
					var el = document.createElement('li'), opc;
					//opc = note == 'New list' ? '' : '<span class="delete">&#10006;</span>';
					opc = '<span class="rename option">S</span><span class="delete option">&#10006;</span>';
					el.innerHTML = '<span class="txt">'+note+'</span>' + opc;
					el.draggable = true;
					menulist.insertBefore(el, newnote);
					applyDragHandlers(el);
			}

			function deleteNote(name){
				var lists = localStorage.getItemJSON(listsPrefix);
				for(var i=0; i<lists.length; i++){
					if(lists[i] == name){
						lists.splice(i,1);
					}
				}
				localStorage.setItem(listsPrefix, JSON.stringify(lists));
				localStorage.setItem(notesPrefix+name, '');
				localStorage.removeItem(notesPrefix+name);
				if(lists.length == 0){
					loadNote();
					return;
				}
				if(localStorage.getItem(lastPrefix) == name){
					loadNote(lists[0]);
					return;
				}
			}

			function cleanStylesAndSpaces(val){
				return val.replace(/(style=(\")[^\"]*(\"))|(style=(\')[^\']*(\'))|^((\s)*(&nbsp;)*)/g,'').replace(/\s+/,' ');
			}

			textarea.addEventListener('keydown', function(evt){
				if(evt.metaKey && evt.keyIdentifier== "U+0053"){
					var status = document.getElementById('status');
					saveContent();
					evt.preventDefault();
					status.innerHTML = 'note saved as: '+localStorage.getItem(lastPrefix);
					status.className = 'show';
					setTimeout(function(){
						status.className = 'show hide';
					}, 200);

				}
				return false;
			});



			//MENU Drag N Drop
			var elem, menuItems = document.querySelectorAll('#menu li:not(#newnote)');
			
			function handleDragStart(e) {
			  this.addClassName('dragging');  // this / e.target is the source node.

			  dragSrcEl = this;

			  e.dataTransfer.effectAllowed = 'move';
			  e.dataTransfer.setData('text/html', this.innerHTML);
			}

			function handleDragOver(e) {
			  if (e.preventDefault) {
			    e.preventDefault(); // Necessary. Allows us to drop.
			  }

			  e.dataTransfer.dropEffect = 'move';  // See the section on the DataTransfer object.

			  return false;
			}

			function handleDragEnter(e) {
			  // this / e.target is the current hover target.
			  if(!this.hasClassName('dragging'))
			  	this.addClassName('over');
			}

			function handleDragLeave(e) {
			  this.removeClassName('over');  // this / e.target is previous target element.
			}

			function handleDrop(e) {
			  // this / e.target is current target element.

			  if (e.stopPropagation) {
			    e.stopPropagation(); // stops the browser from redirecting.
			  }

			  // Don't do anything if dropping the same column we're dragging.
			  if (dragSrcEl != this) {
			    // Set the source column's HTML to the HTML of the columnwe dropped on.
			    //dragSrcEl.innerHTML = this.innerHTML;
			    //this.innerHTML = e.dataTransfer.getData('text/html');
			    var prev = menulist.removeChild(dragSrcEl),
			    	prevTxt = prev.getElementsByClassName('txt')[0].innerHTML,
			    	thisTxt = this.getElementsByClassName('txt')[0].innerHTML;
			    menulist.insertBefore(prev, this);
			    var lists  = localStorage.getItemJSON(listsPrefix);
			    for(var i=0; i<lists.length; i++){
			    	if(lists[i].replace(notesPrefix,'') === prevTxt){
			    		lists.splice(i, 1);
			    		break;
			    	}
			    }
			    for(var i=0; i<lists.length; i++){
			    	if(lists[i].replace(notesPrefix,'') === thisTxt){
			    		lists.splice(i, 0, prevTxt);
			    		break;
			    	}
			    }
			    localStorage.setItem(listsPrefix, JSON.stringify(lists));
			  }


			  // See the section on the DataTransfer object.

			  return false;
			}

			function handleDragEnd(e) {
			  // this/e.target is the source node.

			  [].forEach.call(document.querySelectorAll('#menu li:not(#newnote)'), function (col) {
			    col.removeClassName('over');
			    col.removeClassName('dragging');
			  });
			}

			function applyDragHandlers(col) {
			  col.addEventListener('dragstart', handleDragStart, false);
			  col.addEventListener('dragenter', handleDragEnter, false);
			  col.addEventListener('dragover', handleDragOver, false);
			  col.addEventListener('dragleave', handleDragLeave, false);
			  col.addEventListener('drop', handleDrop, false);
			  col.addEventListener('dragend', handleDragEnd, false);
			}

			[].forEach.call(menuItems, applyDragHandlers);

		</script>
	</body>
</html>