<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" manifest="manifest.cache">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<title i18n-content="appname">Note Editor</title>
		<link rel="shortcut icon" href="http://davsket.me/notes/sicon.png">
		<!-- <link href='http://fonts.googleapis.com/css?family=Asap:400,700' rel='stylesheet' type='text/css'> -->
		<link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
		<!-- <link href='http://fonts.googleapis.com/css?family=Actor' rel='stylesheet' type='text/css'> -->


		<link rel="stylesheet" type="text/css" href="css/screen.css" />
	</head>
	<body>
		<div id="menu">
			<span href="#" class="index">Â²</span>
			<div class="items">
				<ul id="menulist">
					<li id="newnote">
						New Note
					</li>
				</ul>
			</div>
		</div>
		<div id="textarea" spellcheck="true" contenteditable ></div>
		<div id="status" class='hide'></div>
		<div id="modal">
			<div class="back"></div>
			<div class="container">
				<div class="content">
				</div>
				<button class="close">x</button>
			</div>
		</div>
		<script type="text/javascript">
			var actualnote = '',
				listsPrefix = 'notes/lists',
				notesPrefix = 'notes/lists/',
				lastPrefix = 'notes/lastlist',
				clearTextarea = false,
				modal = new Modal();

			Storage.prototype.getItemJSON = function(item){
				var val = this.getItem(item)||'null';
				try{
					return JSON.parse(val);
				}catch(e){
					return val;
				}
			}
			Element.prototype.hasClassName = function(name) {
			  return new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)").test(this.className);
			};

			Element.prototype.addClassName = function(name) {
			  if (!this.hasClassName(name)) {
			    this.className = this.className ? [this.className, name].join(' ') : name;
			  }
			};

			Element.prototype.removeClassName = function(name) {
			  if (this.hasClassName(name)) {
			    var c = this.className;
			    this.className = c.replace(new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)", "g"), "");
			  }
			};

			function getStyle(elem, styleProp)
			{
				return elem.currentStyle ? elem.currentStyle[styleProp] : window.getComputedStyle(elem,null).getPropertyValue(styleProp);
			}
			
			initialize();

			function saveContent(){
				localStorage.setItem(notesPrefix+localStorage.getItem(lastPrefix), textarea.innerHTML);
				if(clearTextarea){
					clearTextarea = false;
					textarea.innerHTML = cleanStylesAndSpaces(textarea.innerHTML);
				}
			}

			textarea.addEventListener('keyup', saveContent);
			textarea.addEventListener('paste', function(evt){
				clearTextarea = true;
				saveContent();
				clearTextarea = true;
			});

			function cancel(evt){
				evt.preventDefault();
			    evt.dataTransfer.dropEffect = 'copy';
				return false;
			}
			textarea.addEventListener('dragenter', cancel);
			textarea.addEventListener('dragover', cancel);

			textarea.addEventListener('drop', function(evt){
				evt.preventDefault();
				//console.log(evt.dataTransfer);

				
				if (evt.dataTransfer.types){
					//console.log(evt.dataTransfer.types);
				    [].forEach.call(evt.dataTransfer.types, function (type) {
				    	if(type == 'text/html'){
				    		evt.target.innerHTML += cleanStylesAndSpaces(evt.dataTransfer.getData(type));
				    	}
				    	else if(type == 'Files'){
				    		var file = evt.dataTransfer.files[0],
								reader = new FileReader();
							if(file.type.match(/image/)){
								reader.onload = function (event) {
									evt.target.innerHTML += '<img src="'+event.target.result+'" />';
								};
							}
							reader.readAsDataURL(file);
							soma = file;
				    	}
				    });
				    
				} else {
					evt.target.innerHTML = evt.dataTransfer.getData('Text');
				}

				return false;
			});

			newnote.addEventListener('click', function(evt){
				modal.prompt('New note name:', function(name){
					if(name){
						createNote(name);
						loadNote(name);
					}
				});
			});

			menulist.addEventListener('click', function(evt){
				var tn = evt.target.tagName, name, bool;
				if(tn == 'LI' && evt.target.getElementsByClassName('txt').length){
					loadNote(evt.target.getElementsByClassName('txt')[0].innerHTML);
				}
				else if(tn == 'SPAN' && !/option/.test(evt.target.className)){
					loadNote(evt.target.parentElement.getElementsByClassName('txt')[0].innerHTML);
				}
				else if(tn == 'SPAN' && /delete/.test(evt.target.className)){
					name = evt.target.parentElement.getElementsByClassName('txt')[0].innerHTML;
					modal.confirm('Are you sure you want to delete the note: '+name+'?', function(bool){
						if(!bool){
							return false;
						} 
						else{
							menulist.removeChild(evt.target.parentElement);
							deleteNote(name);
						}
					});
					
				}
				else if(tn == 'SPAN' && /rename/.test(evt.target.className)){
					var text = evt.target.parentElement.getElementsByClassName('txt')[0],
						oldname = text.innerHTML;
					modal.prompt('New name:', (function(text, oldname){
						return function(name){
							if(!name){
								return false;
							} 
							else{
								text.innerHTML = name;
								localStorage.setItem(notesPrefix+name, localStorage.getItem(notesPrefix+oldname));
								newlists = localStorage.getItemJSON(listsPrefix);
								newlists.push(name);
								localStorage.setItem(listsPrefix, JSON.stringify(newlists));
								deleteNote(oldname);
								loadNote(name);
							}
						}
					})(text, oldname));
				}
			});

			function initialize(){
				var lists, i, list, length;
				lists = localStorage.getItemJSON(listsPrefix);
				if(!lists || lists.length == 0){
					loadNote();
				}
				else{
					for (i = 0; i < lists.length; i++) {
						list = lists[i];
						createMenuItem(list);
					}
					loadNote(localStorage.getItemJSON(lastPrefix));
				}
			}

			function loadNote(noteName){
				if(!noteName){
					noteName = 'New note';
					createNote(noteName);
				}
				localStorage.setItem(lastPrefix, noteName);
				textarea.innerHTML = localStorage.getItemJSON(notesPrefix+noteName) || 'Write something...';

				//length = textarea.innerHTML.length;
				//textarea.scrollTop = textarea.scrollHeight;
				//textarea.setSelectionRange(length, length);
				textarea.focus();
				document.title = 'Editing ' + noteName;
			}

			function createNote(name, ignore_new_item){
				lists = localStorage.getItemJSON(listsPrefix);
				if(!lists){
					lists = [];
				}
				for(var i=0; i<lists.length; i++){
					if(lists[i] == name){
						alert('Already extists anote with the name: '+name+'. Opening note '+name+'.');
						loadNote(name);
						return false;
					}
				}
				if(!ignore_new_item){
					createMenuItem(name);
				}
				lists.push(name)
				localStorage.setItem(listsPrefix,JSON.stringify(lists));
			}

			function createMenuItem(note){
					var el = document.createElement('li'), opc;
					//opc = note == 'New list' ? '' : '<span class="delete">&#10006;</span>';
					opc = '<span class="rename option">S</span><span class="delete option">&#10006;</span>';
					el.innerHTML = '<span class="txt">'+note+'</span>' + opc;
					el.draggable = true;
					menulist.insertBefore(el, newnote);
					applyDragHandlers(el);
			}

			function deleteNote(name){
				var lists = localStorage.getItemJSON(listsPrefix);
				for(var i=0; i<lists.length; i++){
					if(lists[i] == name){
						lists.splice(i,1);
					}
				}
				localStorage.setItem(listsPrefix, JSON.stringify(lists));
				localStorage.setItem(notesPrefix+name, '');
				localStorage.removeItem(notesPrefix+name);
				if(lists.length == 0){
					loadNote();
					return;
				}
				if(localStorage.getItem(lastPrefix) == name){
					loadNote(lists[0]);
					return;
				}
			}

			function cleanStylesAndSpaces(val){
				return val.replace(/(style=(\")[^\"]*(\"))|(style=(\')[^\']*(\'))|^((\s)*(&nbsp;)*)/g,'').replace(/\s+/,' ');
			}

			textarea.addEventListener('keydown', function(evt){
				if(evt.metaKey && evt.keyIdentifier== "U+0053"){
					var status = document.getElementById('status');
					saveContent();
					evt.preventDefault();
					status.innerHTML = 'note saved as: '+localStorage.getItem(lastPrefix);
					status.className = 'show';
					setTimeout(function(){
						status.className = 'show hide';
					}, 200);

				}
				return false;
			});



			//MENU Drag N Drop
			var elem, menuItems = document.querySelectorAll('#menu li:not(#newnote)');
			
			function handleDragStart(e) {
			  this.addClassName('dragging');  // this / e.target is the source node.

			  dragSrcEl = this;

			  e.dataTransfer.effectAllowed = 'move';
			  e.dataTransfer.setData('text/html', this.innerHTML);
			}

			function handleDragOver(e) {
			  if (e.preventDefault) {
			    e.preventDefault(); // Necessary. Allows us to drop.
			  }

			  e.dataTransfer.dropEffect = 'move';  // See the section on the DataTransfer object.

			  return false;
			}

			function handleDragEnter(e) {
			  // this / e.target is the current hover target.
			  if(!this.hasClassName('dragging'))
			  	this.addClassName('over');
			}

			function handleDragLeave(e) {
			  this.removeClassName('over');  // this / e.target is previous target element.
			}

			function handleDrop(e) {
			  // this / e.target is current target element.

			  if (e.stopPropagation) {
			    e.stopPropagation(); // stops the browser from redirecting.
			  }

			  // Don't do anything if dropping the same column we're dragging.
			  if (dragSrcEl != this) {
			    // Set the source column's HTML to the HTML of the columnwe dropped on.
			    //dragSrcEl.innerHTML = this.innerHTML;
			    //this.innerHTML = e.dataTransfer.getData('text/html');
			    var prev = menulist.removeChild(dragSrcEl),
			    	prevTxt = prev.getElementsByClassName('txt')[0].innerHTML,
			    	thisTxt = this.getElementsByClassName('txt')[0].innerHTML;
			    menulist.insertBefore(prev, this);
			    var lists  = localStorage.getItemJSON(listsPrefix);
			    for(var i=0; i<lists.length; i++){
			    	if(lists[i].replace(notesPrefix,'') === prevTxt){
			    		lists.splice(i, 1);
			    		break;
			    	}
			    }
			    for(var i=0; i<lists.length; i++){
			    	if(lists[i].replace(notesPrefix,'') === thisTxt){
			    		lists.splice(i, 0, prevTxt);
			    		break;
			    	}
			    }
			    localStorage.setItem(listsPrefix, JSON.stringify(lists));
			  }


			  // See the section on the DataTransfer object.

			  return false;
			}

			function handleDragEnd(e) {
			  // this/e.target is the source node.

			  [].forEach.call(document.querySelectorAll('#menu li:not(#newnote)'), function (col) {
			    col.removeClassName('over');
			    col.removeClassName('dragging');
			  });
			}

			function applyDragHandlers(col) {
			  col.addEventListener('dragstart', handleDragStart, false);
			  col.addEventListener('dragenter', handleDragEnter, false);
			  col.addEventListener('dragover', handleDragOver, false);
			  col.addEventListener('dragleave', handleDragLeave, false);
			  col.addEventListener('drop', handleDrop, false);
			  col.addEventListener('dragend', handleDragEnd, false);
			}

			[].forEach.call(menuItems, applyDragHandlers);



			//Modal
			function Modal(content, closable){
				var modal = document.getElementById('modal'),
					closeB = modal.getElementsByClassName('close')[0],
					contentW = modal.getElementsByClassName('content')[0],
					back = modal.getElementsByClassName('back')[0];
				this.show = function(){
					modal.className = 'show';
				}
				this.hide = function(){
					modal.className = '';
				}
				this.setContent = function(content){
					contentW.innerHTML = '';
					if(typeof content == 'object'){
						contentW.appendChild(content);
					}else if(typeof content == 'string'){
						contentW.innerHTML = content;
					}
				}
				this.setClosable = function(closable){
					closeB.style.display = closable ? 'block' : 'none';
				}

				//setup
				this.setContent(content);
				this.setClosable(closable);
				closeB.onclick = (function(modal){
					return function(){modal.hide();};
					})(this);
				

				this.confirm = function(question, callback){
					var wrapper = document.createElement('div'),
						message = document.createElement('div'),
						ok = document.createElement('button'),
						cancel = document.createElement('button');
					wrapper.className = 'prompt';
					message.className = 'message';
					ok.className = 'ok';
					cancel.className = 'cancel';
					
					message.innerHTML = question;
					ok.innerHTML = 'ok';
					cancel.innerHTML = 'cancel';

					ok.onclick = (function(modal, callback){
						return function(){
							modal.hide();
							callback(true);
						}
					})(this, callback);

					cancel.onclick = (function(modal, callback){
						return function(){
							modal.hide();
							callback(false);
						}
					})(this, callback);

					this.setClosable(false);

					contentW.innerHTML = '';
					wrapper.appendChild(message);
					wrapper.appendChild(ok);
					wrapper.appendChild(cancel);
					contentW.appendChild(wrapper);

					this.show();

					ok.focus();
				}


				this.prompt = function(question, callback){
					var wrapper = document.createElement('div'),
						message = document.createElement('div'),
						ok = document.createElement('button'),
						input = document.createElement('input'),
						cancel = document.createElement('button');
					wrapper.className = 'prompt';
					message.className = 'message';
					ok.className = 'ok';
					cancel.className = 'cancel';
					input.className = 'text';
					
					message.innerHTML = question;
					ok.innerHTML = 'ok';
					cancel.innerHTML = 'cancel';

					ok.onclick = (function(modal, callback, input){
						return function(){
							modal.hide();
							callback(input.value);
						}
					})(this, callback, input);

					cancel.onclick = (function(modal, callback){
						return function(){
							modal.hide();
							callback(null);
						}
					})(this, callback);

					this.setClosable(false);

					contentW.innerHTML = '';
					wrapper.appendChild(message);
					wrapper.appendChild(input);
					wrapper.appendChild(document.createElement('br'));
					wrapper.appendChild(ok);
					wrapper.appendChild(cancel);
					contentW.appendChild(wrapper);

					this.show();

					input.focus();
				}
			}
		</script>
	</body>
</html>